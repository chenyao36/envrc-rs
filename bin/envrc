#!/usr/bin/env python3

from pathlib import Path
from os import getcwd, environ
from os.path import isfile, join, abspath
from sys import argv
from tempfile import NamedTemporaryFile

envrc_path = abspath(__file__)


def bash_prompt_command():
    to_load = get_envrc()
    cur_load = environ.get('ENVRC_LOAD', None)

    if to_load == cur_load:
        # nothing to load
        return

    # import sys
    # sys.stderr.write("to_load: [{}]\n".format(to_load))
    # sys.stderr.write("cur_load: [{}]\n".format(cur_load))

    if not cur_load:
        tmp = NamedTemporaryFile(delete=False)
        tmp.write("exit 0".encode())
        tmp.close()
        # load new rc
        print("""
        echo loading {to_load}
        ENVRC_TMP="{tmp_name}" ENVRC_LOAD="{to_load}" $BASH
        eval "$(cat {tmp_name}; rm {tmp_name})"
        eval "$({envrc_path} bash-prompt-command)"
        """.format(to_load=to_load, envrc_path=envrc_path, tmp_name=tmp.name))
    else:
        print("""
        echo "cd '$PWD'
        export OLDPWD='$OLDPWD'" > $ENVRC_TMP
        echo "unload $ENVRC_LOAD"
        exit 0
        """)


def get_envrc():
    r = Path(getcwd())
    for d in [r] + list(r.parents):
        d = str(d)
        p = join(d, ".envrc")
        if isfile(p):
            return p
    return None


action = argv[1]

if action == 'bash-prompt-command':
    bash_prompt_command()
